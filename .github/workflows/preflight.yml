# .github/workflows/preflight.yml
name: Preflight check tests

on:
  push:
    branches:
      - master
      - '**' # All branches
  pull_request:
    branches:
      - master
  workflow_dispatch: # Allows manual triggering

permissions:
  id-token: write # Required for AWS OIDC authentication
  contents: read # Required to check out the code

jobs:
  preflight-checks:
    runs-on: ubuntu-latest
    env:
      # Default check region (can be overridden by secrets/vars if needed)
      AWS_REGION: "ap-southeast-2"
      # Default Control Tower home region (assumed same as check region unless overridden)
      # Use secrets or vars if it's different or sensitive
      CT_HOME_REGION: "ap-southeast-2"
      # Default CloudFormation stack prefix (can be overridden by secrets/vars)
      # STACK_PREFIX: "AWSAccelerator" # Uses default from script if not set here

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Or your preferred Python 3.9+ version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Optional: Run Pytest Tests (useful for CI validation)
      - name: Run Unit Tests with Coverage
        run: |
          pytest tests/ --cov=preflight_checks --cov-report=xml --cov-report=term-missing

      # Optional: Upload Coverage Report (e.g., to Codecov)
      # - name: Upload coverage reports to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }} # Store Codecov token in GitHub secrets
      #     slug: ${{ github.repository }} 